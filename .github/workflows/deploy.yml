name: Deploy to EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: hanium/bifai

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: bifai_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2

    - name: Wait for MySQL
      run: |
        timeout 60 bash -c 'until nc -z localhost 3306; do sleep 1; done'

    - name: Run tests
      env:
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
      run: ./gradlew test --no-daemon

  build:
    needs: test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2

    - name: Build application
      env:
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
      run: ./gradlew build -x test --no-daemon

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

  security-scan:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Scan image for vulnerabilities
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: latest
      run: |
        echo "Running security scan..."
        # ECR ìë™ ìŠ¤ìº”ì´ í™œì„±í™”ë˜ì–´ ìˆì–´ ë³„ë„ ìŠ¤ìº” ìƒëµ
        echo "Security scan completed"

  deploy:
    needs: [test, build, security-scan]
    runs-on: ubuntu-latest
    timeout-minutes: 20  # íƒ€ì„ì•„ì›ƒì„ 20ë¶„ìœ¼ë¡œ ì¦ê°€

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy to EC2
      env:
        PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        HOSTNAME: ${{ secrets.EC2_HOST }}
        USER_NAME: ${{ secrets.EC2_USER }}
      run: |
        echo "$PRIVATE_KEY" > /tmp/ssh_key
        chmod 600 /tmp/ssh_key

        ssh -o StrictHostKeyChecking=no -i /tmp/ssh_key $USER_NAME@$HOSTNAME '
        aws --version &&
        aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY_URL }} &&

        echo "=== ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ===" &&
        docker stop bifai-backend || true &&
        docker rm bifai-backend || true &&
        docker stop redis || true &&
        docker rm redis || true &&

        echo "=== Redis ì‹œì‘ ===" &&
        docker run -d --name redis --restart unless-stopped -p 6379:6379 redis:7-alpine &&

        echo "=== ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ===" &&
        docker pull ${{ secrets.ECR_REGISTRY_URL }}/hanium/bifai:latest &&

        echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ (ê°œì„ ëœ ì„¤ì •) ===" &&
        docker run -d --name bifai-backend \
          --restart unless-stopped \
          -p 8080:8080 \
          -v /home/$USER_NAME:/home/$USER_NAME \
          --health-cmd="curl -f http://localhost:8080/api/health || exit 1" \
          --health-interval=30s \
          --health-timeout=15s \
          --health-retries=5 \
          --health-start-period=120s \
          -e SPRING_PROFILES_ACTIVE=prod \
          -e DB_HOST=bifai-db-prod.cncwewgskk3u.ap-northeast-2.rds.amazonaws.com \
          -e DB_PORT=3306 \
          -e DB_NAME=bifai_db \
          -e DB_USER=${{ secrets.DB_USER }} \
          -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
          -e REDIS_HOST=localhost \
          -e REDIS_PORT=6379 \
          -e AWS_REGION=ap-northeast-2 \
          -e S3_BUCKET_NAME=bifai-images-prod \
          -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
          -e OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
          -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
          -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
          -e JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC" \
          ${{ secrets.ECR_REGISTRY_URL }}/hanium/bifai:latest &&

        echo "=== ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° (2ë¶„) ===" &&
        sleep 120 &&

        echo "=== ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ===" &&
        docker ps | grep bifai-backend &&

        echo "=== ì´ˆê¸° ë¡œê·¸ í™•ì¸ ===" &&
        docker logs bifai-backend --tail 30 &&

        echo "=== Health Check (í™•ì¥ëœ íƒ€ì„ì•„ì›ƒ: 15ë¶„) ===" &&
        timeout 900 bash -c "
          retry_count=0
          max_retries=90
          while [ \$retry_count -lt \$max_retries ]; do
            echo \"ì‹œë„ \$((retry_count + 1))/\$max_retries - Health Check í…ŒìŠ¤íŠ¸ ì¤‘...\"

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ ë¨¼ì € í™•ì¸
            if ! docker ps | grep -q bifai-backend; then
              echo \"âŒ ì»¨í…Œì´ë„ˆê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!\"
              docker logs bifai-backend --tail 20
              exit 1
            fi

            # Health endpoint í…ŒìŠ¤íŠ¸
            if curl -f -m 15 http://localhost:8080/api/health; then
              echo \"âœ… Health Check ì„±ê³µ!\"
              echo \"ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!\"
              exit 0
            fi

            echo \"Health Check ì‹¤íŒ¨, 10ì´ˆ í›„ ì¬ì‹œë„...\"
            echo \"=== ìµœê·¼ ë¡œê·¸ (ë§ˆì§€ë§‰ 5ì¤„) ===\"
            docker logs bifai-backend --tail 5
            echo \"=========================\"
            sleep 10
            retry_count=\$((retry_count + 1))
          done

          echo \"âŒ Health Checkê°€ 15ë¶„ í›„ì—ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤\"
          echo \"=== ì „ì²´ ì»¨í…Œì´ë„ˆ ë¡œê·¸ ===\"
          docker logs bifai-backend
          echo \"=== ì»¨í…Œì´ë„ˆ ìƒíƒœ ===\"
          docker ps -a | grep bifai
          exit 1
        " &&

        echo "=== ìµœì¢… í™•ì¸ ===" &&
        curl -f http://localhost:8080/api/health &&
        echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
        '